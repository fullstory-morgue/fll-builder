#!/bin/bash

fetch_source_uris() {
	# download source packages used in ISO creation
	# dump into $FLL_BUILD_SOURCE/{source,kernel}
	local CHROOTPKGLIST=$(mktemp -p $FLL_BUILD_CHROOT fll.pkglist.XXXX)
	local CHROOTSRCLIST=$(mktemp -p $FLL_BUILD_CHROOT fll.srclist.XXXX)
	
	# XXX: some packages mysteriously fail to download when =version is suffixed
	# chroot_exec COLUMNS=250 dpkg --list | awk -v kvers=$KVERS \
	#	'/^[hi]i/{ if($2 !~ kvers) { printf("%s=%s\n", $2, $3) }}' > "$CHROOTPKGLIST"
	
	# XXX: damned kernel packages have no source, filter KVERS
	chroot_exec COLUMNS=250 dpkg --list | awk -v kvers=$KVERS \
		'/^[hi]i/{ if($2 !~ kvers) { print $2 }}' > "$CHROOTPKGLIST"
	
	chroot_exec apt-get -qq --print-uris source $(< $CHROOTPKGLIST) | sort | \
		awk '{ gsub(/'\''/,"", $1); print $1 }' > "$CHROOTSRCLIST"
}

fetch_source_uris
