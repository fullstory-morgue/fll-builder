#!/bin/bash

make_exclude_file() {
	local LIST="$1"
	local FINDOPTS=( "-name '*.orig'" )
	local TYPE REGX TEST

	while read TYPE REGX; do
		[[ $TYPE && $REGX ]] || continue

		case "$REGX" in
			*/*)
				TEST=wholename
				;;
			*)
				TEST=name
				;;
		esac

		case "$TYPE" in
			d|f)
				FINDOPTS+=( "-o -type $TYPE -${TEST} '$REGX'" )
				;;
			*)
				FINDOPTS+=( "-o -${TEST} '$REGX'" )
				;;
		esac
	done < "$LIST"

	eval find . ${FINDOPTS[@]}
}

make_compressed_image() {
	local SQUASHFSEXCLUDEFILE=$(mktemp -p $FLL_BUILD_TEMP fll.squashfs-exclude-file.XXXXX)
	local SQUASHFSEXCLUSIONSLIST=$(mktemp -p $FLL_BUILD_TEMP fll.squashfs-exclusions-list.XXXXX)
	local MKSQUASHFSOPTS=( "-ef $SQUASHFSEXCLUDEFILE" )

	if [[ -s $FLL_BUILD_EXCLUSION_LIST ]]; then
		echo "> Create squashfs exclusions file based on $FLL_BUILD_EXCLUSION_LIST."
		cat "$FLL_BUILD_EXCLUSION_LIST" > "$SQUASHFSEXCLUSIONSLIST"
		pushd "$FLL_BUILD_CHROOT" >/dev/null
			make_exclude_file "$SQUASHFSEXCLUSIONSLIST" > "$SQUASHFSEXCLUDEFILE"
		popd >/dev/null
	fi
	
	if [[ -s $FLL_BUILD_SQUASHFS_SORTFILE ]]; then
		MKSQUASHFSOPTS+=( "-sort $FLL_BUILD_SQUASHFS_SORTFILE" )
	fi

	echo "> Create squashfs."
	pushd "$FLL_BUILD_CHROOT" >/dev/null
		mksquashfs . "$FLL_BUILD_RESULT"/"$FLL_IMAGE_LOCATION" ${MKSQUASHFSOPTS[@]}
	popd >/dev/null

	# md5sums
	pushd "$FLL_BUILD_RESULT" >/dev/null
		( \
			find .	\
				-type f \
				-not \( \
					-name '*md5sums' \
					-o -name '*.cat' \
					-o -name 'iso9660_stage1_5' \
					-o -name 'stage2_eltorito' \
				\) -printf '%P\n' | \
			sort | xargs md5sum -b \
		) > "$FLL_IMAGE_DIR"/md5sums
	popd >/dev/null
}

make_compressed_image
